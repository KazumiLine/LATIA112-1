{% extends "base.html" %}
{% block title %}管理後台 - 訂單詳情 #{{ order.id }}{% endblock %}
{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3><i class="bi bi-receipt"></i> 訂單詳情 #{{ order.id }}</h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('admin_orders') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> 返回訂單列表
      </a>
      <button class="btn btn-primary" onclick="printOrder()">
        <i class="bi bi-printer"></i> 列印訂單
      </button>
    </div>
  </div>

  <!-- Order Status Banner -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h5 class="mb-1">訂單狀態</h5>
          <div class="d-flex align-items-center gap-3">
            {% if order.status.value == 1 %}
              <span class="badge bg-warning fs-6">待付款</span>
            {% elif order.status.value == 2 %}
              <span class="badge bg-success fs-6">已付款</span>
            {% elif order.status.value == 3 %}
              <span class="badge bg-info fs-6">已發貨</span>
            {% else %}
              <span class="badge bg-danger fs-6">退款</span>
            {% endif %}
            <small class="text-muted">最後更新：{{ order.updated_at.strftime('%Y-%m-%d %H:%M') if order.updated_at else '—' }}</small>
          </div>
        </div>
        <div class="col-md-6 text-md-end">
          <h5 class="mb-1">訂單總額</h5>
          <div class="fs-4 fw-bold text-success">NT$ {{ "{:,}".format(order.total) }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Order Information -->
    <div class="col-lg-8">
      <!-- Customer Information -->
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-person"></i> 客戶資訊</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">客戶姓名</label>
              <p class="mb-0">{{ order.user.name if order.user else '—' }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Email</label>
              <p class="mb-0">{{ order.user.email if order.user else '—' }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">電話</label>
              <p class="mb-0">{{ order.user.phone if order.user and order.user.phone else '—' }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">會員等級</label>
              <p class="mb-0">
                {% if order.user and order.user.level %}
                  {% if order.user.level.value == 1 %}
                    <span class="badge bg-secondary">一般會員</span>
                  {% elif order.user.level.value == 2 %}
                    <span class="badge bg-info">銀卡會員</span>
                  {% else %}
                    <span class="badge bg-warning">金卡會員</span>
                  {% endif %}
                {% else %}
                  —
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Items -->
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-cart"></i> 訂單項目</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>商品</th>
                  <th>細項</th>
                  <th>單價</th>
                  <th>數量</th>
                  <th>小計</th>
                </tr>
              </thead>
              <tbody>
                {% for item in order.order_items %}
                <tr>
                  <td>
                    {% if item.product_item and item.product_item.product %}
                      <div class="d-flex align-items-center">
                        {% if item.product_item.product.picture %}
                          <img src="{{ item.product_item.product.picture }}" alt="{{ item.product_item.product.name }}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px;" class="me-2">
                        {% endif %}
                        <div>
                          <div class="fw-bold">{{ item.product_item.product.name }}</div>
                          <small class="text-muted">{{ item.product_item.product.catalog }}</small>
                        </div>
                      </div>
                    {% else %}
                      <span class="text-muted">商品已刪除</span>
                    {% endif %}
                  </td>
                  <td>{{ item.product_item.name if item.product_item else '—' }}</td>
                  <td>NT$ {{ "{:,}".format(item.product_item.price) if item.product_item else 0 }}</td>
                  <td>{{ item.quantity }}</td>
                  <td class="fw-bold">NT$ {{ "{:,}".format((item.product_item.price * item.quantity) if item.product_item else 0) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Order History -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-clock-history"></i> 訂單紀錄</h5>
        </div>
        <div class="card-body">
          <div class="timeline">
            {% for log in order.logs %}
            <div class="timeline-item mb-3">
              <div class="d-flex">
                <div class="timeline-marker me-3">
                  <i class="bi bi-circle-fill text-primary"></i>
                </div>
                <div class="timeline-content">
                  <div class="fw-bold">{{ log.action }}</div>
                  <div class="text-muted small">
                    {% if log.from_status and log.to_status %}
                      狀態：{{ log.from_status }} → {{ log.to_status }}
                    {% endif %}
                    {% if log.note %}
                      <br>備註：{{ log.note }}
                    {% endif %}
                  </div>
                  <div class="text-muted small">{{ log.created_at.strftime('%Y-%m-%d %H:%M') if log.created_at else '—' }}</div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar Actions -->
    <div class="col-lg-4">
      <!-- Order Actions -->
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-gear"></i> 訂單操作</h5>
        </div>
        <div class="card-body">
          <form method="post" action="{{ url_for('admin_order_update_status', order_id=order.id) }}">
            <div class="mb-3">
              <label class="form-label fw-bold">更新狀態</label>
              <select class="form-select" name="status" required>
                <option value="1" {% if order.status.value == 1 %}selected{% endif %}>待付款</option>
                <option value="2" {% if order.status.value == 2 %}selected{% endif %}>已付款</option>
                <option value="3" {% if order.status.value == 3 %}selected{% endif %}>已發貨</option>
                <option value="4" {% if order.status.value == 4 %}selected{% endif %}>退款</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-save"></i> 更新狀態
            </button>
          </form>
        </div>
      </div>

      <!-- Logistics Information -->
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-truck"></i> 物流資訊</h5>
        </div>
        <div class="card-body">
          <form method="post" action="{{ url_for('admin_order_update_delivery', order_id=order.id) }}">
            <div class="mb-3">
              <label class="form-label fw-bold">配送地址</label>
              <input type="text" class="form-control" name="destination" value="{{ order.delivery.destination if order.delivery else '' }}" placeholder="收貨地址">
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">配送方式</label>
              <select class="form-select" name="method">
                <option value="HOME_DELIVERY" {% if order.delivery and order.delivery.method.value == 'HOME_DELIVERY' %}selected{% endif %}>宅配</option>
                <option value="PICKUP" {% if order.delivery and order.delivery.method.value == 'PICKUP' %}selected{% endif %}>自取</option>
                <option value="COURIER" {% if order.delivery and order.delivery.method.value == 'COURIER' %}selected{% endif %}>快遞</option>
                <option value="POSTAL" {% if order.delivery and order.delivery.method.value == 'POSTAL' %}selected{% endif %}>郵寄</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">運費</label>
              <input type="number" class="form-control" name="freight" value="{{ order.delivery.freight if order.delivery else 0 }}" min="0" step="1">
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">備註</label>
              <textarea class="form-control" name="remark" rows="2" placeholder="物流備註">{{ order.delivery.remark if order.delivery else '' }}</textarea>
            </div>
            <button type="submit" class="btn btn-outline-primary w-100">
              <i class="bi bi-save"></i> 更新物流
            </button>
          </form>
        </div>
      </div>

      <!-- Payment Information -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-credit-card"></i> 付款資訊</h5>
        </div>
        <div class="card-body">
          <form method="post" action="{{ url_for('admin_order_update_payment', order_id=order.id) }}">
            <div class="mb-3">
              <label class="form-label fw-bold">付款方式</label>
              <select class="form-select" name="payment_method">
                <option value="credit_card" {% if order.payment and order.payment.payment_method == 'credit_card' %}selected{% endif %}>信用卡</option>
                <option value="apple_pay" {% if order.payment and order.payment.payment_method == 'apple_pay' %}selected{% endif %}>Apple Pay</option>
                <option value="line_pay" {% if order.payment and order.payment.payment_method == 'line_pay' %}selected{% endif %}>LINE Pay</option>
                <option value="bank_transfer" {% if order.payment and order.payment.payment_method == 'bank_transfer' %}selected{% endif %}>銀行轉帳</option>
                <option value="cod" {% if order.payment and order.payment.payment_method == 'cod' %}selected{% endif %}>貨到付款</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">付款狀態</label>
              <div class="form-control-plaintext">
                {% if order.payment %}
                  {% if order.payment.status.value == 1 %}
                    <span class="badge bg-warning">待付款</span>
                  {% elif order.payment.status.value == 2 %}
                    <span class="badge bg-success">已付款</span>
                  {% elif order.payment.status.value == 3 %}
                    <span class="badge bg-danger">付款失敗</span>
                  {% else %}
                    <span class="badge bg-info">已退款</span>
                  {% endif %}
                {% else %}
                  <span class="badge bg-secondary">未建立</span>
                {% endif %}
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">付款詳情</label>
              <textarea class="form-control" name="details" rows="2" placeholder="付款相關備註">{{ order.payment.details if order.payment else '' }}</textarea>
            </div>
            <button type="submit" class="btn btn-outline-primary w-100">
              <i class="bi bi-save"></i> 更新付款
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.timeline {
  position: relative;
}

.timeline-item {
  position: relative;
}

.timeline-marker {
  position: relative;
  top: 0.25rem;
}

.timeline-marker i {
  font-size: 0.5rem;
}

.timeline-content {
  flex: 1;
}

@media print {
  .btn, .form-control, .form-select, .card-header {
    display: none !important;
  }
  
  .card {
    border: none !important;
    box-shadow: none !important;
  }
  
  .card-body {
    padding: 0 !important;
  }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function printOrder() {
  window.print();
}

// Auto-hide forms after submission
document.addEventListener('DOMContentLoaded', function() {
  const forms = document.querySelectorAll('form');
  forms.forEach(form => {
    form.addEventListener('submit', function() {
      setTimeout(() => {
        showToast('成功', '資料已更新', 'success');
      }, 1000);
    });
  });
});
</script>
{% endblock %}
{% extends "base.html" %}
{% block title %}管理後台 - 優惠券管理{% endblock %}
{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3><i class="bi bi-ticket-detailed"></i> 優惠券管理</h3>
    <button class="btn btn-primary" onclick="showModal('addCouponModal')">
      <i class="bi bi-plus-circle"></i> 新增優惠券
    </button>
  </div>

  <!-- Coupons Table -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>類型</th>
              <th>折扣</th>
              <th>最低金額</th>
              <th>剩餘數量</th>
              <th>建立時間</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            {% for c in coupons %}
            <tr>
              <td>#{{ c.id }}</td>
              <td>
                {% if c.type.value == 1 %}
                  <span class="badge bg-info">打折(%)</span>
                {% else %}
                  <span class="badge bg-warning">定額折扣</span>
                {% endif %}
              </td>
              <td>
                {% if c.type.value == 1 %}
                  <span class="text-success fw-bold">{{ c.discount }}%</span>
                {% else %}
                  <span class="text-success fw-bold">NT$ {{ "{:,}".format(c.discount) }}</span>
                {% endif %}
              </td>
              <td><span class="badge bg-secondary">NT$ {{ "{:,}".format(c.min_price) }}</span></td>
              <td>
                <span class="badge {% if c.remain_count > 10 %}bg-success{% elif c.remain_count > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                  {{ c.remain_count }}
                </span>
              </td>
              <td>{{ c.created_at.strftime('%Y-%m-%d %H:%M') if c.created_at else '—' }}</td>
              <td>
                <div class="btn-group" role="group">
                  <button class="btn btn-sm btn-outline-primary" onclick="editCoupon({{ c.id }}, {{ c.type.value }}, {{ c.discount }}, {{ c.min_price }}, {{ c.remain_count }})">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteCoupon({{ c.id }}, '{{ c.type.name }}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      {% if not coupons %}
      <div class="text-center py-5">
        <i class="bi bi-ticket-detailed text-muted" style="font-size: 3rem;"></i>
        <p class="text-muted mt-3">尚未建立任何優惠券</p>
        <button class="btn btn-primary" onclick="showModal('addCouponModal')">
          <i class="bi bi-plus-circle"></i> 新增第一個優惠券
        </button>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Add Coupon Modal -->
<div class="modal fade" id="addCouponModal" tabindex="-1" aria-labelledby="addCouponModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCouponModalLabel">
          <i class="bi bi-plus-circle"></i> 新增優惠券
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">優惠券類型 *</label>
              <select class="form-select" name="type" required>
                <option value="">請選擇類型</option>
                <option value="1">打折(%)</option>
                <option value="2">定額折扣</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">折扣值 *</label>
              <input class="form-control" type="number" name="discount" required min="1" step="1" placeholder="打折請輸入1-99，定額請輸入金額">
            </div>
            <div class="col-md-6">
              <label class="form-label">最低消費金額 *</label>
              <input class="form-control" type="number" name="min_price" required min="0" step="1" placeholder="NT$">
            </div>
            <div class="col-md-6">
              <label class="form-label">剩餘數量 *</label>
              <input class="form-control" type="number" name="remain_count" required min="1" step="1" placeholder="可使用的數量">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" type="submit">建立優惠券</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Coupon Modal -->
<div class="modal fade" id="editCouponModal" tabindex="-1" aria-labelledby="editCouponModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editCouponModalLabel">
          <i class="bi bi-pencil"></i> 編輯優惠券
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editCouponForm" method="post">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">優惠券類型 *</label>
              <select class="form-select" name="type" id="editCouponType" required>
                <option value="1">打折(%)</option>
                <option value="2">定額折扣</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">折扣值 *</label>
              <input class="form-control" type="number" name="discount" id="editCouponDiscount" required min="1" step="1">
            </div>
            <div class="col-md-6">
              <label class="form-label">最低消費金額 *</label>
              <input class="form-control" type="number" name="min_price" id="editCouponMinPrice" required min="0" step="1">
            </div>
            <div class="col-md-6">
              <label class="form-label">剩餘數量 *</label>
              <input class="form-control" type="number" name="remain_count" id="editCouponRemainCount" required min="1" step="1">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" type="submit">更新優惠券</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Coupon Modal -->
<div class="modal fade" id="deleteCouponModal" tabindex="-1" aria-labelledby="deleteCouponModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteCouponModalLabel">
          <i class="bi bi-exclamation-triangle text-warning"></i> 確認刪除
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>確定要刪除優惠券 <strong id="deleteCouponName"></strong> 嗎？</p>
        <p class="text-muted small">此操作無法復原，請謹慎操作。</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <form id="deleteCouponForm" method="post" style="display: inline;">
          <button class="btn btn-danger" type="submit">確認刪除</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function editCoupon(id, type, discount, minPrice, remainCount) {
  document.getElementById('editCouponType').value = type;
  document.getElementById('editCouponDiscount').value = discount;
  document.getElementById('editCouponMinPrice').value = minPrice;
  document.getElementById('editCouponRemainCount').value = remainCount;
  
  const form = document.getElementById('editCouponForm');
  form.action = `/admin/coupons/${id}/edit`;
  
  showModal('editCouponModal');
}

function deleteCoupon(id, typeName) {
  document.getElementById('deleteCouponName').textContent = typeName;
  document.getElementById('deleteCouponForm').action = `/admin/coupons/${id}/delete`;
  showModal('deleteCouponModal');
}

// Auto-hide modals after form submission
document.addEventListener('DOMContentLoaded', function() {
  const forms = document.querySelectorAll('form');
  forms.forEach(form => {
    form.addEventListener('submit', function() {
      setTimeout(() => {
        const modal = this.closest('.modal');
        if (modal) {
          hideModal(modal.id);
        }
      }, 1000);
    });
  });
});
</script>
{% endblock %}
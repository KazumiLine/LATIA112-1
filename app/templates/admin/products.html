{% extends "base.html" %}
{% block title %}管理後台 - 商品管理{% endblock %}
{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3><i class="bi bi-box"></i> 商品管理</h3>
    <button class="btn btn-primary" onclick="showModal('addProductModal')">
      <i class="bi bi-plus-circle"></i> 新增商品
    </button>
  </div>

  <!-- Search Bar -->
  <div class="card mb-3">
    <div class="card-body">
      <form method="get" class="row g-3">
        <div class="col-md-4">
          <input type="text" class="form-control" name="q" value="{{ q }}" placeholder="搜尋商品名稱或分類...">
        </div>
        <div class="col-md-3">
          <select class="form-select" name="store_id">
            <option value="">全部商店</option>
            {% for store in stores %}
              <option value="{{ store.id }}" {% if current_store_id == store.id %}selected{% endif %}>
                {{ store.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" name="status">
            <option value="">全部狀態</option>
            <option value="1" {% if request.args.get('status') == '1' %}selected{% endif %}>正常</option>
            <option value="2" {% if request.args.get('status') == '2' %}selected{% endif %}>隱藏</option>
          </select>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-outline-primary w-100">
            <i class="bi bi-search"></i> 搜尋
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Products Table -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>圖片</th>
              <th>名稱</th>
              <th>分類</th>
              <th>簡介</th>
              <th>狀態</th>
              <th>建立時間</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            {% for p in products %}
            <tr>
              <td>#{{ p.id }}</td>
              <td>
                {% if p.picture %}
                  <img src="{{ p.picture }}" alt="{{ p.name }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">
                {% else %}
                  <div class="bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; border-radius: 5px;">
                    <i class="bi bi-image text-muted"></i>
                  </div>
                {% endif %}
              </td>
              <td>{{ p.name }}</td>
              <td><span class="badge bg-secondary">{{ p.catalog }}</span></td>
              <td>{{ p.descriptions[:50] + '...' if p.descriptions and p.descriptions|length > 50 else p.descriptions or '無' }}</td>
              <td>
                {% if p.status.value == 1 %}
                  <span class="badge bg-success">正常</span>
                {% else %}
                  <span class="badge bg-warning">隱藏</span>
                {% endif %}
              </td>
              <td>{{ p.created_at.strftime('%Y-%m-%d %H:%M') if p.created_at else '—' }}</td>
              <td>
                <div class="btn-group" role="group">
                  <button class="btn btn-sm btn-outline-primary" onclick="editProduct({{ p.id }}, '{{ p.name }}', '{{ p.catalog }}', '{{ p.descriptions or '' }}', '{{ p.detail or '' }}', '{{ p.picture or '' }}')">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <a href="{{ url_for('admin_product_items', pid=p.id) }}" class="btn btn-sm btn-outline-info">
                    <i class="bi bi-list-ul"></i>
                  </a>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct({{ p.id }}, '{{ p.name }}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addProductModalLabel">
          <i class="bi bi-plus-circle"></i> 新增商品
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('admin_product_new') }}">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">商品名稱 *</label>
              <input type="text" class="form-control" name="name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">分類 *</label>
              <input type="text" class="form-control" name="catalog" required>
            </div>
            <div class="col-12">
              <label class="form-label">簡介</label>
              <textarea class="form-control" name="descriptions" rows="3" placeholder="商品簡短描述..."></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">詳細說明</label>
              <textarea class="form-control" name="detail" rows="4" placeholder="商品詳細規格、材質、保固等..."></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">圖片URL</label>
              <input type="url" class="form-control" name="picture" placeholder="https://example.com/image.jpg">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">新增商品</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProductModalLabel">
          <i class="bi bi-pencil"></i> 編輯商品
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editProductForm" method="post">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">商品名稱 *</label>
              <input type="text" class="form-control" name="name" id="editName" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">分類 *</label>
              <input type="text" class="form-control" name="catalog" id="editCatalog" required>
            </div>
            <div class="col-12">
              <label class="form-label">簡介</label>
              <textarea class="form-control" name="descriptions" id="editDescriptions" rows="3" placeholder="商品簡短描述..."></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">詳細說明</label>
              <textarea class="form-control" name="detail" id="editDetail" rows="4" placeholder="商品詳細規格、材質、保固等..."></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">圖片URL</label>
              <input type="url" class="form-control" name="picture" id="editPicture" placeholder="https://example.com/image.jpg">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">更新商品</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteProductModal" tabindex="-1" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteProductModalLabel">
          <i class="bi bi-exclamation-triangle text-warning"></i> 確認刪除
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>確定要隱藏商品 <strong id="deleteProductName"></strong> 嗎？</p>
        <p class="text-muted small">此操作會將商品狀態設為隱藏，不會真正刪除資料。</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <form id="deleteProductForm" method="post" style="display: inline;">
          <button type="submit" class="btn btn-danger">確認隱藏</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function editProduct(id, name, catalog, descriptions, detail, picture) {
  document.getElementById('editName').value = name;
  document.getElementById('editCatalog').value = catalog;
  document.getElementById('editDescriptions').value = descriptions;
  document.getElementById('editDetail').value = detail;
  document.getElementById('editPicture').value = picture;
  
  const form = document.getElementById('editProductForm');
  form.action = `/admin/products/${id}/edit`;
  
  showModal('editProductModal');
}

function deleteProduct(id, name) {
  document.getElementById('deleteProductName').textContent = name;
  document.getElementById('deleteProductForm').action = `/admin/products/${id}/delete`;
  showModal('deleteProductModal');
}

// Auto-hide modals after form submission
document.addEventListener('DOMContentLoaded', function() {
  const forms = document.querySelectorAll('form');
  forms.forEach(form => {
    form.addEventListener('submit', function() {
      setTimeout(() => {
        const modal = this.closest('.modal');
        if (modal) {
          hideModal(modal.id);
        }
      }, 1000);
    });
  });
});
</script>
{% endblock %}